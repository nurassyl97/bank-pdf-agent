<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–Ω–∞–ª–∏–∑ Kaspi Gold</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0b1220;
      color: #e5e7eb;
      line-height: 1.6;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .card {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
    h2 { font-size: 20px; font-weight: 600; margin-bottom: 16px; color: #cbd5e1; }
    h3 { font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #9ca3af; }
    .summary-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px; margin-top: 16px;
    }
    .summary-item {
      background: rgba(2, 6, 23, 0.6);
      border: 1px solid rgba(55, 65, 81, 0.5);
      border-radius: 12px;
      padding: 16px;
    }
    .summary-label { font-size: 13px; color: #9ca3af; margin-bottom: 8px; }
    .summary-value {
      font-size: 24px; font-weight: 700;
      margin-bottom: 4px;
    }
    .positive { color: #22c55e; }
    .negative { color: #f97373; }
    .insight {
      font-size: 14px; color: #cbd5e1; margin-top: 16px;
      padding: 12px; background: rgba(34, 197, 94, 0.1);
      border-left: 3px solid #22c55e; border-radius: 4px;
    }
    .insight.warning {
      background: rgba(239, 68, 68, 0.1);
      border-left-color: #f97373;
    }
    .chart-container {
      position: relative; height: 300px; margin: 20px 0;
    }
    .chart-container.small { height: 250px; }
    .credit-warning {
      padding: 16px; border-radius: 12px; margin-top: 16px;
      border: 2px solid;
    }
    .credit-warning.low { background: rgba(34, 197, 94, 0.1); border-color: #22c55e; }
    .credit-warning.medium { background: rgba(251, 191, 36, 0.1); border-color: #fbbf24; }
    .credit-warning.high { background: rgba(239, 68, 68, 0.1); border-color: #f97373; }
    .leak-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px; background: rgba(2, 6, 23, 0.4);
      border-radius: 8px; margin-bottom: 8px;
    }
    .recommendation {
      background: rgba(2, 6, 23, 0.6);
      border-left: 4px solid #3b82f6;
      border-radius: 8px;
      padding: 16px; margin-bottom: 12px;
    }
    .recommendation-title { font-weight: 600; margin-bottom: 8px; color: #60a5fa; }
    .recommendation-desc { font-size: 14px; color: #cbd5e1; margin-bottom: 12px; }
    .recommendation-savings {
      display: flex; gap: 16px; font-size: 13px;
    }
    .recommendation-savings span { color: #9ca3af; }
    .recommendation-savings strong { color: #22c55e; }
    .impact-badge {
      display: inline-block; padding: 4px 10px; border-radius: 999px;
      font-size: 11px; font-weight: 600;
    }
    .impact-high { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .impact-medium { background: rgba(251, 191, 36, 0.2); color: #fcd34d; }
    .impact-low { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; }
    .upload-section {
      text-align: center; padding: 32px;
    }
    .btn {
      display: inline-block; padding: 14px 28px;
      background: linear-gradient(135deg, #22c55e, #a3e635);
      color: #0b1120; border: none; border-radius: 999px;
      font-size: 15px; font-weight: 600; cursor: pointer;
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(34, 197, 94, 0.4); }
    .btn:active { transform: translateY(0); }
    #file-input { display: none; }
    .status { margin-top: 16px; font-size: 14px; color: #9ca3af; }
    .status.error { color: #f97373; }
  </style>
</head>
<body>
  <div class="container">
    <div id="upload-section" class="card upload-section">
      <h1>Kaspi Gold ‚Äî –∞–Ω–∞–ª–∏–∑ –≤—ã–ø–∏—Å–∫–∏</h1>
      <p style="margin: 16px 0; color: #9ca3af;">
        –ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF-–≤—ã–ø–∏—Å–∫—É Kaspi (–¥–æ 1 –ú–ë) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
      </p>
      <button class="btn" onclick="document.getElementById('file-input').click()">–ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑</button>
      <input type="file" id="file-input" accept="application/pdf" />
      <div id="status" class="status"></div>
    </div>

    <div id="report" style="display: none;">
      <!-- 1. Financial Summary -->
      <div class="card">
        <h2>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞</h2>
        <div class="summary-grid" id="summary-grid"></div>
        <div id="summary-insight" class="insight"></div>
      </div>

      <!-- 2. Income vs Expenses Over Time -->
      <div class="card">
        <h2>–î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h2>
        <div class="chart-container">
          <canvas id="income-expenses-chart"></canvas>
        </div>
        <p style="font-size: 14px; color: #9ca3af; margin-top: 12px;">
          –ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É –≤–∞—à–∏—Ö –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–µ—Ä–∏–æ–¥—ã, –∫–æ–≥–¥–∞ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –¥–æ—Ö–æ–¥—ã.
        </p>
      </div>

      <!-- 3. Expense Breakdown -->
      <div class="card">
        <h2>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤</h2>
        <div class="chart-container small">
          <canvas id="expense-donut-chart"></canvas>
        </div>
        <div id="expense-insight" style="margin-top: 16px;"></div>
      </div>

      <!-- 4. Credits and Installments -->
      <div class="card">
        <h2>–ö—Ä–µ–¥–∏—Ç—ã –∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∏</h2>
        <div id="credit-analysis"></div>
      </div>

      <!-- 5. Money Leaks -->
      <div class="card">
        <h2>–ù–µ–∑–∞–º–µ—Ç–Ω—ã–µ —Ç—Ä–∞—Ç—ã</h2>
        <div id="leak-analysis"></div>
      </div>

      <!-- 6. Recommendations -->
      <div class="card">
        <h2>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
        <div id="recommendations"></div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://bank-pdf-agent.onrender.com/analyze';
    let incomeExpensesChart = null;
    let expenseDonutChart = null;

    function formatKZT(v) {
      if (v === null || v === undefined || isNaN(v)) return '‚Äî';
      return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'KZT',
        maximumFractionDigits: 0
      }).format(v);
    }

    function formatPercent(v) {
      return v.toFixed(1) + '%';
    }

    document.getElementById('file-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 1000000) {
        showStatus('–§–∞–π–ª –±–æ–ª—å—à–µ 1 –ú–ë', true);
        return;
      }

      showStatus('–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–ø–∏—Å–∫—É...');
      const formData = new FormData();
      formData.append('file', file);
      formData.append('bank', 'kaspi');
      formData.append('currency', 'KZT');

      try {
        const res = await fetch(API_URL, { method: 'POST', body: formData });
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + res.status);
        const data = await res.json();
        showStatus('');
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('report').style.display = 'block';
        renderReport(data);
      } catch (err) {
        showStatus('–û—à–∏–±–∫–∞: ' + err.message, true);
      }
    });

    function showStatus(text, isError = false) {
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = isError ? 'status error' : 'status';
    }

    function renderReport(data) {
      renderSummary(data);
      renderIncomeExpensesChart(data);
      renderExpenseDonut(data);
      renderCreditAnalysis(data);
      renderLeakAnalysis(data);
      renderRecommendations(data);
    }

    function renderSummary(data) {
      const totals = data.totals || {};
      const net = totals.net || 0;
      const income = totals.income || 0;
      const spending = totals.spending || 0;
      const diffPercent = income > 0 ? ((spending / income) * 100) : 0;

      const grid = document.getElementById('summary-grid');
      grid.innerHTML = `
        <div class="summary-item">
          <div class="summary-label">–î–æ—Ö–æ–¥—ã</div>
          <div class="summary-value positive">${formatKZT(income)}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">–†–∞—Å—Ö–æ–¥—ã</div>
          <div class="summary-value negative">${formatKZT(spending)}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">–ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
          <div class="summary-value ${net >= 0 ? 'positive' : 'negative'}">${formatKZT(net)}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">–†–∞—Å—Ö–æ–¥—ã –æ—Ç –¥–æ—Ö–æ–¥–æ–≤</div>
          <div class="summary-value ${diffPercent <= 100 ? 'positive' : 'negative'}">${formatPercent(diffPercent)}</div>
        </div>
      `;

      const insight = document.getElementById('summary-insight');
      if (net >= 0) {
        insight.className = 'insight';
        insight.textContent = `‚úÖ –í—ã –≤ –ø–ª—é—Å–µ! –ó–∞ –ø–µ—Ä–∏–æ–¥ –≤—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ –Ω–∞ ${formatKZT(net)} –±–æ–ª—å—à–µ, —á–µ–º –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏. –≠—Ç–æ —Ö–æ—Ä–æ—à–∏–π –∑–Ω–∞–∫ –¥–ª—è –≤–∞—à–µ–≥–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è.`;
      } else {
        insight.className = 'insight warning';
        insight.textContent = `‚ö†Ô∏è –í–∞—à–∏ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –¥–æ—Ö–æ–¥—ã –Ω–∞ ${formatKZT(Math.abs(net))}. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ª–∏–±–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ—Ö–æ–¥—ã, –ª–∏–±–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–æ–ª–≥–æ–≤.`;
      }
    }

    function renderIncomeExpensesChart(data) {
      const monthly = data.monthly_summary || [];
      if (monthly.length === 0) return;

      const ctx = document.getElementById('income-expenses-chart').getContext('2d');
      if (incomeExpensesChart) incomeExpensesChart.destroy();

      incomeExpensesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthly.map(m => m.month),
          datasets: [{
            label: '–î–æ—Ö–æ–¥—ã',
            data: monthly.map(m => m.income),
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.4,
            fill: true
          }, {
            label: '–†–∞—Å—Ö–æ–¥—ã',
            data: monthly.map(m => m.spending),
            borderColor: '#f97373',
            backgroundColor: 'rgba(249, 115, 115, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          },
          scales: {
            x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
            y: { ticks: { color: '#9ca3af', callback: (v) => formatKZT(v) }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
          }
        }
      });
    }

    function renderExpenseDonut(data) {
      const categories = (data.category_breakdown || []).filter(c => c.spending > 0);
      if (categories.length === 0) return;

      const ctx = document.getElementById('expense-donut-chart').getContext('2d');
      if (expenseDonutChart) expenseDonutChart.destroy();

      const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#6366f1', '#ef4444', '#14b8a6'];
      const total = categories.reduce((sum, c) => sum + c.spending, 0);

      expenseDonutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: categories.map(c => c.category),
          datasets: [{
            data: categories.map(c => c.spending),
            backgroundColor: colors.slice(0, categories.length),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right', labels: { color: '#e5e7eb', padding: 15 } },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const label = ctx.label || '';
                  const value = ctx.parsed || 0;
                  const percent = ((value / total) * 100).toFixed(1);
                  return `${label}: ${formatKZT(value)} (${percent}%)`;
                }
              }
            }
          }
        }
      });

      const transfers = categories.find(c => c.category === 'transfers');
      const insight = document.getElementById('expense-insight');
      if (transfers && transfers.spending > total * 0.4) {
        insight.innerHTML = `<div class="insight warning">‚ö†Ô∏è –ü–µ—Ä–µ–≤–æ–¥—ã —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç ${formatPercent((transfers.spending / total) * 100)} –≤–∞—à–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–≤–æ–¥—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã.</div>`;
      } else {
        const topCat = categories[0];
        insight.innerHTML = `<div class="insight">üí° –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤—ã —Ç—Ä–∞—Ç–∏—Ç–µ –Ω–∞ "${topCat.category}" ‚Äî ${formatPercent((topCat.spending / total) * 100)} –≤—Å–µ—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤.</div>`;
      }
    }

    function renderCreditAnalysis(data) {
      const credit = data.credit_analysis || {};
      const container = document.getElementById('credit-analysis');

      if (!credit.total_monthly || credit.total_monthly === 0) {
        container.innerHTML = '<p style="color: #9ca3af;">–ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤ –≤—ã–ø–∏—Å–∫–µ.</p>';
        return;
      }

      const warningClass = credit.warning_level || 'low';
      const warningText = {
        low: '–ù–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞',
        medium: '–°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ ‚Äî —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ',
        high: '–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å—Ä–æ—á–Ω–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ'
      };

      container.innerHTML = `
        <div class="credit-warning ${warningClass}">
          <h3 style="margin-bottom: 12px;">${warningText[warningClass]}</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
            <div>
              <div style="font-size: 13px; color: #9ca3af; margin-bottom: 4px;">–°—Ä–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂ –≤ –º–µ—Å—è—Ü</div>
              <div style="font-size: 24px; font-weight: 700; color: ${warningClass === 'high' ? '#f97373' : '#fbbf24'}">${formatKZT(credit.total_monthly)}</div>
            </div>
            <div>
              <div style="font-size: 13px; color: #9ca3af; margin-bottom: 4px;">% –æ—Ç –≤—Å–µ—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
              <div style="font-size: 24px; font-weight: 700; color: ${warningClass === 'high' ? '#f97373' : '#fbbf24'}">${formatPercent(credit.percentage_of_expenses)}</div>
            </div>
          </div>
        </div>
      `;

      if (credit.recurring_payments && credit.recurring_payments.length > 0) {
        container.innerHTML += '<h3 style="margin-top: 24px;">–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:</h3>';
        credit.recurring_payments.forEach(p => {
          container.innerHTML += `
            <div class="leak-item">
              <div>
                <div style="font-weight: 600;">${p.merchant}</div>
                <div style="font-size: 12px; color: #9ca3af;">${p.frequency} –ø–ª–∞—Ç–µ–∂(–µ–π)</div>
              </div>
              <div style="font-weight: 700; color: #f97373;">${formatKZT(p.monthly_amount)}</div>
            </div>
          `;
        });
      }
    }

    function renderLeakAnalysis(data) {
      const leaks = data.money_leaks || {};
      const container = document.getElementById('leak-analysis');

      if (!leaks.leak_sources || leaks.leak_sources.length === 0) {
        container.innerHTML = '<p style="color: #9ca3af;">–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–µ–∑–∞–º–µ—Ç–Ω—ã—Ö —Ç—Ä–∞—Ç –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.</p>';
        return;
      }

      container.innerHTML = `
        <div class="insight warning">
          üí∏ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${leaks.leak_sources.length} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –Ω–µ–∑–∞–º–µ—Ç–Ω—ã—Ö —Ç—Ä–∞—Ç, –∫–æ—Ç–æ—Ä—ã–µ –≤ —Å—É–º–º–µ —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç ${formatKZT(leaks.total_monthly)} –≤ –º–µ—Å—è—Ü.
        </div>
        <div style="margin-top: 16px;">
          ${leaks.leak_sources.map(leak => `
            <div class="leak-item">
              <div>
                <div style="font-weight: 600;">${leak.merchant}</div>
                <div style="font-size: 12px; color: #9ca3af;">${leak.count} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, —Å—Ä–µ–¥–Ω—è—è: ${formatKZT(leak.avg)}</div>
              </div>
              <div style="font-weight: 700; color: #f97373;">${formatKZT(leak.total)}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderRecommendations(data) {
      const recs = data.recommendations || [];
      const container = document.getElementById('recommendations');

      if (recs.length === 0) {
        container.innerHTML = '<p style="color: #9ca3af;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</p>';
        return;
      }

      container.innerHTML = recs.map(rec => `
        <div class="recommendation">
          <div class="recommendation-title">${rec.title}</div>
          <div class="recommendation-desc">${rec.description}</div>
          <div class="recommendation-savings">
            <span>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è:</span>
            <strong>${formatKZT(rec.monthly_savings)}/–º–µ—Å—è—Ü</strong>
            <span class="impact-badge impact-${rec.impact === '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π' || rec.impact === '–í—ã—Å–æ–∫–∏–π' ? 'high' : rec.impact === '–°—Ä–µ–¥–Ω–∏–π' ? 'medium' : 'low'}">${rec.impact}</span>
          </div>
        </div>
      `).join('');
    }
  </script>
</body>
</html>
