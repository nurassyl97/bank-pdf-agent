<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–Ω–∞–ª–∏–∑ Kaspi Gold</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0b1220;
      color: #e5e7eb;
      line-height: 1.6;
      padding: 20px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .card {
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
    h2 { font-size: 20px; font-weight: 600; margin-bottom: 16px; color: #cbd5e1; }
    h3 { font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #9ca3af; }
    .summary-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px; margin-top: 16px;
    }
    .summary-item {
      background: rgba(2, 6, 23, 0.6);
      border: 1px solid rgba(55, 65, 81, 0.5);
      border-radius: 12px;
      padding: 16px;
    }
    .summary-label { font-size: 13px; color: #9ca3af; margin-bottom: 8px; }
    .summary-value {
      font-size: 24px; font-weight: 700;
      margin-bottom: 4px;
    }
    .positive { color: #22c55e; }
    .negative { color: #f97373; }
    .insight {
      font-size: 14px; color: #cbd5e1; margin-top: 16px;
      padding: 12px; background: rgba(34, 197, 94, 0.1);
      border-left: 3px solid #22c55e; border-radius: 4px;
    }
    .insight.warning {
      background: rgba(239, 68, 68, 0.1);
      border-left-color: #f97373;
    }
    .chart-container {
      position: relative; height: 300px; margin: 20px 0;
    }
    .chart-container.small { height: 250px; }
    .credit-warning {
      padding: 16px; border-radius: 12px; margin-top: 16px;
      border: 2px solid;
    }
    .credit-warning.low { background: rgba(34, 197, 94, 0.1); border-color: #22c55e; }
    .credit-warning.medium { background: rgba(251, 191, 36, 0.1); border-color: #fbbf24; }
    .credit-warning.high { background: rgba(239, 68, 68, 0.1); border-color: #f97373; }
    .leak-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px; background: rgba(2, 6, 23, 0.4);
      border-radius: 8px; margin-bottom: 8px;
    }
    .recommendation {
      background: rgba(2, 6, 23, 0.6);
      border-left: 4px solid #3b82f6;
      border-radius: 8px;
      padding: 16px; margin-bottom: 12px;
    }
    .recommendation-title { font-weight: 600; margin-bottom: 8px; color: #60a5fa; }
    .recommendation-desc { font-size: 14px; color: #cbd5e1; margin-bottom: 12px; }
    .recommendation-savings {
      display: flex; gap: 16px; font-size: 13px;
    }
    .recommendation-savings span { color: #9ca3af; }
    .recommendation-savings strong { color: #22c55e; }
    .impact-badge {
      display: inline-block; padding: 4px 10px; border-radius: 999px;
      font-size: 11px; font-weight: 600;
    }
    .impact-high { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .impact-medium { background: rgba(251, 191, 36, 0.2); color: #fcd34d; }
    .impact-low { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; }
    .upload-section {
      text-align: center; padding: 32px;
    }
    .btn {
      display: inline-block; padding: 14px 28px;
      background: linear-gradient(135deg, #22c55e, #a3e635);
      color: #0b1120; border: none; border-radius: 999px;
      font-size: 15px; font-weight: 600; cursor: pointer;
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(34, 197, 94, 0.4); }
    .btn:active { transform: translateY(0); }
    #file-input { display: none; }
    .status { margin-top: 16px; font-size: 14px; color: #9ca3af; }
    .status.error { color: #f97373; }
    .question { margin-bottom: 24px; }
    .question-label { font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #cbd5e1; }
    .question-options { display: flex; flex-direction: column; gap: 10px; }
    .option-btn {
      padding: 12px 16px; background: rgba(2,6,23,0.6); border: 2px solid rgba(55,65,81,0.5);
      border-radius: 8px; cursor: pointer; text-align: left; transition: all 0.2s;
      color: #e5e7eb; font-size: 14px;
    }
    .option-btn:hover { border-color: #3b82f6; background: rgba(59,130,246,0.1); }
    .option-btn.selected { border-color: #3b82f6; background: rgba(59,130,246,0.2); }
    .questionnaire-nav { display: flex; justify-content: space-between; margin-top: 32px; }
    .nav-btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    .nav-btn.primary { background: linear-gradient(135deg, #22c55e, #a3e635); color: #0b1120; }
    .nav-btn.secondary { background: rgba(55,65,81,0.5); color: #e5e7eb; }
    .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .question-number { font-size: 12px; color: #9ca3af; margin-bottom: 8px; }
    .question-help { font-size: 12px; color: #9ca3af; margin-top: 8px; font-style: italic; }
    .number-input {
      width: 100%; padding: 12px 16px; background: rgba(2,6,23,0.6);
      border: 2px solid rgba(55,65,81,0.5); border-radius: 8px;
      color: #e5e7eb; font-size: 14px; margin-top: 8px;
    }
    .number-input:focus { outline: none; border-color: #3b82f6; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Onboarding Questionnaire -->
    <div id="onboarding-section" class="card">
      <h1>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</h1>
      <p style="margin: 16px 0; color: #9ca3af; text-align: center;">
        –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–∞—à–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤
      </p>
      <div id="questionnaire"></div>
    </div>

    <!-- File Upload Section (hidden initially) -->
    <div id="upload-section" class="card upload-section" style="display: none;">
      <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—ã–ø–∏—Å–æ–∫</h2>
      <p style="margin: 16px 0; color: #9ca3af;">
        –¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–∏ –≤—ã–ø–∏—Å–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
      </p>
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600;">–û–±—ã—á–Ω–∞—è –≤—ã–ø–∏—Å–∫–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
        <input type="file" id="file-input" accept="application/pdf" style="display: none;" />
        <button class="btn" onclick="document.getElementById('file-input').click()" style="width: 100%; margin-bottom: 12px;">–í—ã–±—Ä–∞—Ç—å –æ–±—ã—á–Ω—É—é –≤—ã–ø–∏—Å–∫—É</button>
        <div id="file-name" style="font-size: 13px; color: #9ca3af;"></div>
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600;">–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –≤—ã–ø–∏—Å–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
        <input type="file" id="credit-file-input" accept="application/pdf" style="display: none;" />
        <button class="btn" onclick="document.getElementById('credit-file-input').click()" style="width: 100%; margin-bottom: 12px; background: linear-gradient(135deg, #3b82f6, #60a5fa);">–í—ã–±—Ä–∞—Ç—å –∫—Ä–µ–¥–∏—Ç–Ω—É—é –≤—ã–ø–∏—Å–∫—É</button>
        <div id="credit-file-name" style="font-size: 13px; color: #9ca3af;"></div>
        <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–∞—è –≤—ã–ø–∏—Å–∫–∞ –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º –∏ –∑–∞–π–º–∞–º, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –µ—ë –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</p>
      </div>
      <button class="btn" id="analyze-btn" onclick="startAnalysis()" style="width: 100%; background: linear-gradient(135deg, #22c55e, #a3e635);">–ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑</button>
      <div id="status" class="status"></div>
    </div>

    <div id="report" style="display: none;">
      <!-- 0. Financial Health Score -->
      <div class="card">
        <h2>–û—Ü–µ–Ω–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è</h2>
        <div id="health-score" style="text-align: center; padding: 24px 0;"></div>
      </div>

      <!-- Credit Risk Index (if available) -->
      <div id="credit-risk-section" class="card" style="display: none;">
        <h2>–ò–Ω–¥–µ–∫—Å –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ —Ä–∏—Å–∫–∞</h2>
        <div id="credit-risk"></div>
      </div>

      <!-- Real Income Analysis (if available) -->
      <div id="real-income-section" class="card" style="display: none;">
        <h2>–†–µ–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥</h2>
        <div id="real-income"></div>
      </div>

      <!-- Credit Statement Analysis (if available) -->
      <div id="credit-statement-section" class="card" style="display: none;">
        <h2>–ê–Ω–∞–ª–∏–∑ –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –≤—ã–ø–∏—Å–∫–∏</h2>
        <div id="credit-statement-analysis"></div>
      </div>

      <!-- 1. Financial Summary -->
      <div class="card">
        <h2>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞</h2>
        <div class="summary-grid" id="summary-grid"></div>
        <div id="summary-insight" class="insight"></div>
      </div>

      <!-- Safety Buffer -->
      <div class="card">
        <h2>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ø–æ–¥—É—à–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h2>
        <div id="safety-buffer"></div>
      </div>

      <!-- 2. Income vs Expenses Over Time -->
      <div class="card">
        <h2>–î–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h2>
        <div class="chart-container">
          <canvas id="income-expenses-chart"></canvas>
        </div>
        <p style="font-size: 14px; color: #9ca3af; margin-top: 12px;">
          –ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É –≤–∞—à–∏—Ö –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–µ—Ä–∏–æ–¥—ã, –∫–æ–≥–¥–∞ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –¥–æ—Ö–æ–¥—ã.
        </p>
      </div>

      <!-- 3. Expense Breakdown -->
      <div class="card">
        <h2>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤</h2>
        <div class="chart-container small">
          <canvas id="expense-donut-chart"></canvas>
        </div>
        <div id="expense-insight" style="margin-top: 16px;"></div>
      </div>

      <!-- 4. Credits and Installments -->
      <div class="card">
        <h2>–ö—Ä–µ–¥–∏—Ç—ã –∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∏</h2>
        <div id="credit-analysis"></div>
      </div>

      <!-- 5. Money Leaks -->
      <div class="card">
        <h2>–ù–µ–∑–∞–º–µ—Ç–Ω—ã–µ —Ç—Ä–∞—Ç—ã</h2>
        <div id="leak-analysis"></div>
      </div>

      <!-- 6. Future Scenarios -->
      <div class="card">
        <h2>–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –±—É–¥—É—â–µ–µ</h2>
        <div id="future-scenarios"></div>
      </div>

      <!-- 7. Before/After Comparison -->
      <div class="card">
        <h2>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ: —Å–µ–π—á–∞—Å vs –ø–æ—Å–ª–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</h2>
        <div id="before-after"></div>
      </div>

      <!-- 8. 30-Day Action Plan -->
      <div class="card">
        <h2>–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ 30 –¥–Ω–µ–π</h2>
        <div id="action-plan"></div>
      </div>

      <!-- 9. Recommendations -->
      <div class="card">
        <h2>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h2>
        <div id="recommendations"></div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://bank-pdf-agent.onrender.com/analyze';
    let incomeExpensesChart = null;
    let expenseDonutChart = null;

    function formatKZT(v) {
      if (v === null || v === undefined || isNaN(v)) return '‚Äî';
      return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'KZT',
        maximumFractionDigits: 0
      }).format(v);
    }

    function formatPercent(v) {
      return v.toFixed(1) + '%';
    }

    // Onboarding questionnaire state - MANDATORY financial data
    let questionnaireAnswers = {
      monthly_income: null,
      income_stability: null,
      monthly_living_expenses: null,
      monthly_credit_payments: null,
      total_outstanding_debt: null,
      total_debt_range: null,
      financial_safety_months: null,
      primary_goal: null,
    };
    let currentQuestion = 0;

    const questions = [
      {
        id: 'monthly_income',
        label: '–ö–∞–∫–æ–π —É –≤–∞—Å —Å—Ä–µ–¥–Ω–∏–π –º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥? (–≤ —Ç–µ–Ω–≥–µ)',
        type: 'number',
        placeholder: '–ù–∞–ø—Ä–∏–º–µ—Ä: 500000',
        required: true,
        help: '–£–∫–∞–∂–∏—Ç–µ —Å—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü. –ï—Å–ª–∏ –¥–æ—Ö–æ–¥ –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω, —É–∫–∞–∂–∏—Ç–µ —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.',
      },
      {
        id: 'income_stability',
        label: '–ù–∞—Å–∫–æ–ª—å–∫–æ —Å—Ç–∞–±–∏–ª–µ–Ω –≤–∞—à –¥–æ—Ö–æ–¥?',
        type: 'select',
        options: [
          { value: 'stable', label: '–°—Ç–∞–±–∏–ª—å–Ω—ã–π ‚Äî –ø—Ä–∏–º–µ—Ä–Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü' },
          { value: 'fluctuating', label: '–ö–æ–ª–µ–±–ª–µ—Ç—Å—è ‚Äî –º–µ–Ω—è–µ—Ç—Å—è, –Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ' },
          { value: 'unstable', label: '–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π ‚Äî —Å–∏–ª—å–Ω–æ –º–µ–Ω—è–µ—Ç—Å—è, –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ' },
        ],
        required: true,
      },
      {
        id: 'monthly_living_expenses',
        label: '–°–∫–æ–ª—å–∫–æ –≤—ã –æ–±—ã—á–Ω–æ —Ç—Ä–∞—Ç–∏—Ç–µ –≤ –º–µ—Å—è—Ü –Ω–∞ –∂–∏–∑–Ω—å? (–≤ —Ç–µ–Ω–≥–µ, –±–µ–∑ —É—á–µ—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤)',
        type: 'number',
        placeholder: '–ù–∞–ø—Ä–∏–º–µ—Ä: 400000',
        required: true,
        help: '–£–∫–∞–∂–∏—Ç–µ –æ–±—ã—á–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã: –µ–¥–∞, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è. –ë–ï–ó –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π.',
      },
      {
        id: 'monthly_credit_payments',
        label: '–°–∫–æ–ª—å–∫–æ –≤—ã –ø–ª–∞—Ç–∏—Ç–µ –≤ –º–µ—Å—è—Ü –ø–æ –≤—Å–µ–º –∫—Ä–µ–¥–∏—Ç–∞–º –∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∞–º? (–≤ —Ç–µ–Ω–≥–µ)',
        type: 'number',
        placeholder: '–ù–∞–ø—Ä–∏–º–µ—Ä: 100000',
        required: true,
        help: '–°—É–º–º–∞ –≤—Å–µ—Ö –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π: –∫—Ä–µ–¥–∏—Ç—ã, –∑–∞–π–º—ã, —Ä–∞—Å—Å—Ä–æ—á–∫–∏, –∫—Ä–µ–¥–∏—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã.',
      },
      {
        id: 'total_outstanding_debt',
        label: '–ö–∞–∫–æ–π —É –≤–∞—Å –æ–±—â–∏–π –¥–æ–ª–≥? (–≤ —Ç–µ–Ω–≥–µ)',
        type: 'number',
        placeholder: '–ù–∞–ø—Ä–∏–º–µ—Ä: 2000000',
        required: false,
        help: '–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ.',
        optional: true,
      },
      {
        id: 'total_debt_range',
        label: '–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—Ç–µ —Ç–æ—á–Ω—É—é —Å—É–º–º—É –¥–æ–ª–≥–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω:',
        type: 'select',
        options: [
          { value: null, label: '–£–∫–∞–∑–∞–ª —Ç–æ—á–Ω—É—é —Å—É–º–º—É –≤—ã—à–µ' },
          { value: '0-100k', label: '0 - 100,000 —Ç–µ–Ω–≥–µ' },
          { value: '100k-500k', label: '100,000 - 500,000 —Ç–µ–Ω–≥–µ' },
          { value: '500k-1m', label: '500,000 - 1,000,000 —Ç–µ–Ω–≥–µ' },
          { value: '1m-3m', label: '1,000,000 - 3,000,000 —Ç–µ–Ω–≥–µ' },
          { value: '3m+', label: '–ë–æ–ª–µ–µ 3,000,000 —Ç–µ–Ω–≥–µ' },
        ],
        required: false,
        showIf: () => !questionnaireAnswers.total_outstanding_debt,
      },
      {
        id: 'financial_safety_months',
        label: '–ï—Å–ª–∏ –¥–æ—Ö–æ–¥ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—Å—è, –Ω–∞ —Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤ —Ö–≤–∞—Ç–∏—Ç –≤–∞—à–∏—Ö —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π?',
        type: 'select',
        options: [
          { value: '0', label: '0 ‚Äî –Ω–µ—Ç —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π' },
          { value: '<1', label: '–ú–µ–Ω—å—à–µ –º–µ—Å—è—Ü–∞' },
          { value: '1-3', label: '1-3 –º–µ—Å—è—Ü–∞' },
          { value: '3+', label: '–ë–æ–ª–µ–µ 3 –º–µ—Å—è—Ü–µ–≤' },
        ],
        required: true,
      },
      {
        id: 'primary_goal',
        label: '–ö–∞–∫–∞—è –≤–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Ü–µ–ª—å?',
        type: 'select',
        options: [
          { value: 'reduce_debt', label: '–°–Ω–∏–∑–∏—Ç—å –¥–æ–ª–≥–∏ –∏ –∫—Ä–µ–¥–∏—Ç—ã' },
          { value: 'save', label: '–ù–∞–∫–æ–ø–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥—É—à–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏' },
          { value: 'stabilize', label: '–°—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±—é–¥–∂–µ—Ç –∏ —Ä–∞—Å—Ö–æ–¥—ã' },
          { value: 'understand_reality', label: '–ü–æ–Ω—è—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –º–æ–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤' },
        ],
        required: true,
      },
    ];

    function renderQuestion() {
      if (currentQuestion >= questions.length) {
        // Questionnaire complete, show upload section
        document.getElementById('onboarding-section').style.display = 'none';
        document.getElementById('upload-section').style.display = 'block';
        return;
      }

      const question = questions[currentQuestion];
      const container = document.getElementById('questionnaire');
      
      // Check if question should be shown
      if (question.showIf && !question.showIf()) {
        currentQuestion++;
        renderQuestion();
        return;
      }
      
      let inputHtml = '';
      if (question.type === 'number') {
        const value = getAnswerValue(question.id) || '';
        inputHtml = `
          <input type="number" class="number-input" id="input-${question.id}" 
                 placeholder="${question.placeholder || ''}" 
                 value="${value}"
                 onchange="selectAnswer('${question.id}', parseFloat(this.value) || null)"
                 ${question.required ? 'required' : ''} />
        `;
      } else if (question.type === 'select') {
        inputHtml = `
          <div class="question-options">
            ${question.options.map(opt => `
              <button class="option-btn ${getAnswerValue(question.id) === opt.value ? 'selected' : ''}" 
                      onclick="selectAnswer('${question.id}', ${opt.value === null ? 'null' : JSON.stringify(opt.value).replace(/"/g, '&quot;')})">
                ${opt.label}
              </button>
            `).join('')}
          </div>
        `;
      }
      
      const canProceed = question.required ? getAnswerValue(question.id) !== null && getAnswerValue(question.id) !== '' : true;
      
      container.innerHTML = `
        <div class="question-number">–í–æ–ø—Ä–æ—Å ${currentQuestion + 1} –∏–∑ ${questions.length}</div>
        <div class="question">
          <div class="question-label">${question.label}${question.required ? ' *' : ''}</div>
          ${inputHtml}
          ${question.help ? `<div class="question-help">${question.help}</div>` : ''}
        </div>
        <div class="questionnaire-nav">
          <button class="nav-btn secondary" onclick="prevQuestion()" ${currentQuestion === 0 ? 'disabled' : ''}>
            –ù–∞–∑–∞–¥
          </button>
          <button class="nav-btn primary" onclick="nextQuestion()" ${!canProceed ? 'disabled' : ''}>
            ${currentQuestion === questions.length - 1 ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å' : '–î–∞–ª–µ–µ'}
          </button>
        </div>
      `;
    }

    function getAnswerValue(questionId) {
      return questionnaireAnswers[questionId];
    }

    function selectAnswer(questionId, value) {
      questionnaireAnswers[questionId] = value;
      renderQuestion();
    }

    function nextQuestion() {
      if (currentQuestion < questions.length - 1) {
        currentQuestion++;
        renderQuestion();
      } else {
        // Complete questionnaire - move to next step
        currentQuestion++;
        renderQuestion(); // This will detect currentQuestion >= questions.length and show upload
      }
    }

    function prevQuestion() {
      if (currentQuestion > 0) {
        currentQuestion--;
        renderQuestion();
      }
    }

    // File upload handlers
    let regularFile = null;
    let creditFile = null;

    document.getElementById('file-input').addEventListener('change', (e) => {
      regularFile = e.target.files[0];
      document.getElementById('file-name').textContent = regularFile ? regularFile.name : '';
    });

    document.getElementById('credit-file-input').addEventListener('change', (e) => {
      creditFile = e.target.files[0];
      document.getElementById('credit-file-name').textContent = creditFile ? creditFile.name : '–ù–µ –≤—ã–±—Ä–∞–Ω–æ';
    });

    async function startAnalysis() {
      if (!regularFile) {
        showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—ã—á–Ω—É—é –≤—ã–ø–∏—Å–∫—É', true);
        return;
      }

      if (regularFile.size > 1000000) {
        showStatus('–û–±—ã—á–Ω–∞—è –≤—ã–ø–∏—Å–∫–∞ –±–æ–ª—å—à–µ 1 –ú–ë', true);
        return;
      }

      if (creditFile && creditFile.size > 1000000) {
        showStatus('–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –≤—ã–ø–∏—Å–∫–∞ –±–æ–ª—å—à–µ 1 –ú–ë', true);
        return;
      }

      showStatus('–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–ø–∏—Å–∫–∏...');
      const formData = new FormData();
      formData.append('file', regularFile);
      formData.append('bank', 'kaspi');
      formData.append('currency', 'KZT');
      
      // Add questionnaire
      formData.append('questionnaire', JSON.stringify(questionnaireAnswers));
      
      // Add credit statement if provided
      if (creditFile) {
        formData.append('credit_statement', creditFile);
      }

      try {
        const res = await fetch(API_URL, { method: 'POST', body: formData });
        if (!res.ok) {
          let errorDetail = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + res.status;
          try {
            const errorData = await res.json();
            if (errorData.detail) errorDetail = errorData.detail;
          } catch (_) {}
          throw new Error(errorDetail);
        }
        const data = await res.json();
        showStatus('');
        document.getElementById('upload-section').style.display = 'none';
        document.getElementById('report').style.display = 'block';
        renderReport(data);
      } catch (err) {
        console.error('Upload error:', err);
        const errorMsg = err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
        showStatus('–û—à–∏–±–∫–∞: ' + errorMsg, true);
      }
    }

    // Initialize questionnaire
    renderQuestion();

    function showStatus(text, isError = false) {
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = isError ? 'status error' : 'status';
    }

    function renderReport(data) {
      // New sections for combined analysis
      if (data.credit_risk_index) {
        renderCreditRiskIndex(data.credit_risk_index);
        document.getElementById('credit-risk-section').style.display = 'block';
      }
      if (data.real_income_analysis) {
        renderRealIncome(data.real_income_analysis, data.totals);
        document.getElementById('real-income-section').style.display = 'block';
      }
      if (data.credit_statement_analysis && Object.keys(data.credit_statement_analysis).length > 0) {
        renderCreditStatementAnalysis(data.credit_statement_analysis);
        document.getElementById('credit-statement-section').style.display = 'block';
      }
      
      // Existing sections
      renderHealthScore(data);
      renderSummary(data);
      renderSafetyBuffer(data);
      renderIncomeExpensesChart(data);
      renderExpenseDonut(data);
      renderCreditAnalysis(data);
      renderLeakAnalysis(data);
      renderFutureScenarios(data);
      renderBeforeAfter(data);
      renderActionPlan(data);
      renderRecommendations(data);
    }

    function renderCreditRiskIndex(risk) {
      const levelColors = {
        critical: '#f97373',
        dangerous: '#f59e0b',
        risky: '#fbbf24',
        safe: '#22c55e',
      };
      const color = levelColors[risk.level] || '#9ca3af';
      
      document.getElementById('credit-risk').innerHTML = `
        <div style="text-align: center; margin-bottom: 24px;">
          <div style="font-size: 48px; font-weight: 700; color: ${color}; margin-bottom: 8px;">${risk.score}</div>
          <div style="font-size: 20px; font-weight: 600; color: ${color}; margin-bottom: 16px;">${risk.label}</div>
          <div style="font-size: 16px; color: #cbd5e1; max-width: 600px; margin: 0 auto; line-height: 1.6;">
            ${risk.explanation}
          </div>
        </div>
        ${risk.risk_factors && risk.risk_factors.length > 0 ? `
          <div style="margin-top: 24px;">
            <h3 style="margin-bottom: 12px;">–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞:</h3>
            ${risk.risk_factors.map(factor => `
              <div style="padding: 12px; background: rgba(239,68,68,0.1); border-left: 3px solid #f97373; border-radius: 4px; margin-bottom: 8px; font-size: 14px; color: #cbd5e1;">
                ‚ö†Ô∏è ${factor}
              </div>
            `).join('')}
          </div>
        ` : ''}
      `;
    }

    function renderRealIncome(realIncome, totals) {
      const creditDep = realIncome.credit_dependency_ratio || 0;
      const isHighDependency = creditDep > 15;
      
      document.getElementById('real-income').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
          <div style="background: rgba(2,6,23,0.6); padding: 16px; border-radius: 12px;">
            <div style="font-size: 13px; color: #9ca3af; margin-bottom: 4px;">–û–±—â–∏–π –¥–æ—Ö–æ–¥</div>
            <div style="font-size: 24px; font-weight: 700; color: #cbd5e1;">${formatKZT(realIncome.total_income)}</div>
          </div>
          <div style="background: rgba(2,6,23,0.6); padding: 16px; border-radius: 12px; border: 2px solid ${isHighDependency ? '#f97373' : '#22c55e'}40;">
            <div style="font-size: 13px; color: #9ca3af; margin-bottom: 4px;">–ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</div>
            <div style="font-size: 24px; font-weight: 700; color: ${isHighDependency ? '#f97373' : '#9ca3af'};">${formatKZT(realIncome.credit_inflows)}</div>
          </div>
          <div style="background: rgba(2,6,23,0.6); padding: 16px; border-radius: 12px; border: 2px solid #3b82f640;">
            <div style="font-size: 13px; color: #9ca3af; margin-bottom: 4px;">–†–µ–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥</div>
            <div style="font-size: 24px; font-weight: 700; color: #60a5fa;">${formatKZT(realIncome.real_income)}</div>
          </div>
        </div>
        <div class="insight ${isHighDependency ? 'warning' : ''}" style="margin-top: 16px;">
          ${isHighDependency 
            ? `‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤: ${formatPercent(creditDep)} –≤–∞—à–µ–≥–æ –¥–æ—Ö–æ–¥–∞ ‚Äî —ç—Ç–æ –∫—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –±–µ–∑ –Ω–æ–≤—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${formatKZT(realIncome.real_income)}.`
            : `‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤: ${formatPercent(creditDep)} –¥–æ—Ö–æ–¥–∞. –í–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ (–±–µ–∑ –∫—Ä–µ–¥–∏—Ç–æ–≤) —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${formatKZT(realIncome.real_income)}.`
          }
        </div>
      `;
    }

    function renderCreditStatementAnalysis(analysis) {
      if (!analysis || Object.keys(analysis).length === 0) return;
      
      const hasRefinancing = analysis.refinancing_detected || false;
      const spiralRisk = analysis.credit_spiral_risk || 'none';
      
      document.getElementById('credit-statement-analysis').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
          <div style="background: rgba(2,6,23,0.6); padding: 16px; border-radius: 12px;">
            <div style="font-size: 13px; color: #9ca3af; margin-bottom: 4px;">–í—Å–µ–≥–æ –≤—ã–¥–∞–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤</div>
            <div style="font-size: 24px; font-weight: 700; color: #f97373;">${formatKZT(analysis.total_loans_issued || 0)}</div>
          </div>
          <div style="background: rgba(2,6,23,0.6); padding: 16px; border-radius: 12px;">
            <div style="font-size: 13px; color: #9ca3af; margin-bottom: 4px;">–í—Å–µ–≥–æ –ø–æ–≥–∞—à–µ–Ω–æ</div>
            <div style="font-size: 24px; font-weight: 700; color: #22c55e;">${formatKZT(analysis.total_repayments || 0)}</div>
          </div>
          <div style="background: rgba(2,6,23,0.6); padding: 16px; border-radius: 12px;">
            <div style="font-size: 13px; color: #9ca3af; margin-bottom: 4px;">–û—Ü–µ–Ω–æ—á–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –¥–æ–ª–≥</div>
            <div style="font-size: 24px; font-weight: 700; color: ${(analysis.estimated_active_debt || 0) > 0 ? '#f97373' : '#22c55e'};">${formatKZT(analysis.estimated_active_debt || 0)}</div>
          </div>
          <div style="background: rgba(2,6,23,0.6); padding: 16px; border-radius: 12px;">
            <div style="font-size: 13px; color: #9ca3af; margin-bottom: 4px;">–ß–∞—Å—Ç–æ—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤</div>
            <div style="font-size: 24px; font-weight: 700; color: #cbd5e1;">${analysis.loan_frequency || 0}</div>
          </div>
        </div>
        ${hasRefinancing ? `
          <div class="insight warning" style="margin-bottom: 16px;">
            ‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–∏–∑–Ω–∞–∫–∏ —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è: –≤—ã –±–µ—Ä–µ—Ç–µ –Ω–æ–≤—ã–µ –∫—Ä–µ–¥–∏—Ç—ã –¥–ª—è –ø–æ–≥–∞—à–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö. –≠—Ç–æ –æ–ø–∞—Å–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∫—Ä–µ–¥–∏—Ç–Ω–æ–π —Å–ø–∏—Ä–∞–ª–∏.
          </div>
        ` : ''}
        ${spiralRisk !== 'none' ? `
          <div class="insight warning" style="margin-bottom: 16px;">
            ${spiralRisk === 'high' 
              ? 'üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –†–ò–°–ö: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫—Ä–µ–¥–∏—Ç–Ω–∞—è —Å–ø–∏—Ä–∞–ª—å. –í—ã —á–∞—Å—Ç–æ –±–µ—Ä–µ—Ç–µ –Ω–æ–≤—ã–µ –∫—Ä–µ–¥–∏—Ç—ã —Å —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–º–∏—Å—è —Å—É–º–º–∞–º–∏. –≠—Ç–æ –∫—Ä–∞–π–Ω–µ –æ–ø–∞—Å–Ω–æ –¥–ª—è –≤–∞—à–µ–≥–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è.'
              : '‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫: –ß–∞—Å—Ç—ã–µ –Ω–æ–≤—ã–µ –∫—Ä–µ–¥–∏—Ç—ã –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∫—Ä–µ–¥–∏—Ç–Ω–æ–π —Å–ø–∏—Ä–∞–ª–∏.'
            }
          </div>
        ` : ''}
        ${analysis.loan_types && Object.keys(analysis.loan_types).length > 0 ? `
          <div style="margin-top: 16px;">
            <h3 style="margin-bottom: 12px;">–¢–∏–ø—ã –∫—Ä–µ–¥–∏—Ç–æ–≤:</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${Object.entries(analysis.loan_types).map(([type, count]) => `
                <span style="padding: 6px 12px; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 999px; font-size: 13px; color: #60a5fa;">
                  ${type}: ${count}
                </span>
              `).join('')}
            </div>
          </div>
        ` : ''}
      `;
    }

    function renderHealthScore(data) {
      const health = data.health_score || {};
      const score = health.score || 0;
      const status = health.status || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
      const statusColor = health.status_color || "warning";
      const explanation = health.explanation || "";

      const colorMap = {
        positive: "#22c55e",
        warning: "#fbbf24",
        negative: "#f97373",
      };
      const color = colorMap[statusColor] || "#9ca3af";

      document.getElementById('health-score').innerHTML = `
        <div style="margin-bottom: 24px;">
          <div style="font-size: 72px; font-weight: 700; color: ${color}; margin-bottom: 8px;">${score}</div>
          <div style="font-size: 24px; font-weight: 600; color: ${color}; margin-bottom: 16px;">${status}</div>
          <div style="font-size: 16px; color: #cbd5e1; max-width: 600px; margin: 0 auto; line-height: 1.6;">${explanation}</div>
        </div>
        ${health.factors ? `
          <div style="margin-top: 32px; text-align: left; display: grid; gap: 12px;">
            ${health.factors.map(f => `
              <div style="background: rgba(2,6,23,0.6); padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 600; margin-bottom: 4px;">${f.name}</div>
                  <div style="font-size: 13px; color: #9ca3af;">${f.note}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 20px; font-weight: 700; color: ${f.score >= f.max * 0.7 ? '#22c55e' : f.score >= f.max * 0.5 ? '#fbbf24' : '#f97373'};">${f.score}</div>
                  <div style="font-size: 12px; color: #9ca3af;">–∏–∑ ${f.max}</div>
                </div>
              </div>
            `).join('')}
          </div>
        ` : ''}
      `;
    }

    function renderSafetyBuffer(data) {
      const buffer = data.safety_buffer || {};
      const months = buffer.months || 0;
      const status = buffer.status || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
      const statusColor = buffer.status_color || "warning";
      const explanation = buffer.explanation || "";
      const monthlyExpenses = buffer.monthly_expenses || 0;
      const bufferAmount = buffer.buffer_amount || 0;

      const colorMap = {
        positive: "#22c55e",
        warning: "#fbbf24",
        negative: "#f97373",
      };
      const bgColor = colorMap[statusColor] || "#9ca3af";

      document.getElementById('safety-buffer').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
          <div style="background: rgba(2,6,23,0.6); padding: 16px; border-radius: 12px; border: 2px solid ${bgColor}40;">
            <div style="font-size: 13px; color: #9ca3af; margin-bottom: 8px;">–ú–µ—Å—è—Ü–µ–≤ –ø–æ–∫—Ä—ã—Ç–∏—è</div>
            <div style="font-size: 36px; font-weight: 700; color: ${bgColor}; margin-bottom: 4px;">${months}</div>
            <div style="font-size: 14px; font-weight: 600; color: ${bgColor};">${status}</div>
          </div>
          <div style="background: rgba(2,6,23,0.6); padding: 16px; border-radius: 12px;">
            <div style="font-size: 13px; color: #9ca3af; margin-bottom: 8px;">–°—É–º–º–∞ –ø–æ–¥—É—à–∫–∏</div>
            <div style="font-size: 24px; font-weight: 700; color: #cbd5e1;">${formatKZT(bufferAmount)}</div>
          </div>
          <div style="background: rgba(2,6,23,0.6); padding: 16px; border-radius: 12px;">
            <div style="font-size: 13px; color: #9ca3af; margin-bottom: 8px;">–°—Ä–µ–¥–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –≤ –º–µ—Å—è—Ü</div>
            <div style="font-size: 24px; font-weight: 700; color: #cbd5e1;">${formatKZT(monthlyExpenses)}</div>
          </div>
        </div>
        <div class="insight ${statusColor === 'negative' ? 'warning' : ''}" style="margin-top: 16px;">${explanation}</div>
      `;
    }

    function renderFutureScenarios(data) {
      const scenarios = data.future_scenarios || [];
      const container = document.getElementById('future-scenarios');

      if (scenarios.length === 0) {
        container.innerHTML = '<p style="color: #9ca3af;">–ü—Ä–æ–≥–Ω–æ–∑—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</p>';
        return;
      }

      const riskColors = {
        low: "#22c55e",
        medium: "#fbbf24",
        high: "#f97373",
      };

      container.innerHTML = scenarios.map(s => {
        const riskColor = riskColors[s.risk_level] || "#9ca3af";
        return `
          <div style="background: rgba(2,6,23,0.6); border-left: 4px solid ${riskColor}; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
            <h3 style="margin-bottom: 8px;">${s.title}</h3>
            <p style="color: #9ca3af; margin-bottom: 16px; font-size: 14px;">${s.description}</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 16px;">
              <div>
                <div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">–ë–∞–ª–∞–Ω—Å –≤ –º–µ—Å—è—Ü</div>
                <div style="font-size: 20px; font-weight: 700; color: ${s.monthly_balance >= 0 ? '#22c55e' : '#f97373'};">${formatKZT(s.monthly_balance)}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">–ß–µ—Ä–µ–∑ 6 –º–µ—Å—è—Ü–µ–≤</div>
                <div style="font-size: 20px; font-weight: 700; color: ${s['6_month_outcome'] >= 0 ? '#22c55e' : '#f97373'};">${formatKZT(s['6_month_outcome'])}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">–ß–µ—Ä–µ–∑ –≥–æ–¥</div>
                <div style="font-size: 20px; font-weight: 700; color: ${s['12_month_outcome'] >= 0 ? '#22c55e' : '#f97373'};">${formatKZT(s['12_month_outcome'])}</div>
              </div>
            </div>
            <div style="margin-top: 12px; padding: 12px; background: rgba(${riskColor === '#22c55e' ? '34,197,94' : riskColor === '#fbbf24' ? '251,191,36' : '239,68,68'}, 0.1); border-radius: 8px;">
              <div style="font-size: 14px; color: #cbd5e1;">${s.summary}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderBeforeAfter(data) {
      const comparison = data.before_after || {};
      const current = comparison.current || {};
      const after = comparison.after || {};
      const improvement = comparison.improvement || {};

      document.getElementById('before-after').innerHTML = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid rgba(148,163,184,0.3);">
                <th style="text-align: left; padding: 12px; color: #9ca3af; font-weight: 600;">–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
                <th style="text-align: right; padding: 12px; color: #9ca3af; font-weight: 600;">–°–µ–π—á–∞—Å</th>
                <th style="text-align: right; padding: 12px; color: #9ca3af; font-weight: 600;">–ü–æ—Å–ª–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</th>
                <th style="text-align: right; padding: 12px; color: #9ca3af; font-weight: 600;">–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid rgba(148,163,184,0.1);">
                <td style="padding: 12px; font-weight: 600;">–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –≤ –º–µ—Å—è—Ü</td>
                <td style="text-align: right; padding: 12px; color: ${current.net_balance >= 0 ? '#22c55e' : '#f97373'};">${formatKZT(current.net_balance)}</td>
                <td style="text-align: right; padding: 12px; color: ${after.net_balance >= 0 ? '#22c55e' : '#f97373'};">${formatKZT(after.net_balance)}</td>
                <td style="text-align: right; padding: 12px; color: ${improvement.net_change >= 0 ? '#22c55e' : '#f97373'}; font-weight: 700;">${improvement.net_change >= 0 ? '+' : ''}${formatKZT(improvement.net_change)}</td>
              </tr>
              <tr style="border-bottom: 1px solid rgba(148,163,184,0.1);">
                <td style="padding: 12px; font-weight: 600;">–ö—Ä–µ–¥–∏—Ç—ã –æ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</td>
                <td style="text-align: right; padding: 12px;">${formatPercent(current.credit_percentage)}</td>
                <td style="text-align: right; padding: 12px; color: ${after.credit_percentage < current.credit_percentage ? '#22c55e' : '#9ca3af'};">${formatPercent(after.credit_percentage)}</td>
                <td style="text-align: right; padding: 12px; color: #22c55e; font-weight: 700;">-${formatPercent(improvement.credit_reduction)}</td>
              </tr>
              <tr style="border-bottom: 1px solid rgba(148,163,184,0.1);">
                <td style="padding: 12px; font-weight: 600;">–ù–µ–∑–∞–º–µ—Ç–Ω—ã–µ —Ç—Ä–∞—Ç—ã –≤ –º–µ—Å—è—Ü</td>
                <td style="text-align: right; padding: 12px;">${formatKZT(current.money_leaks)}</td>
                <td style="text-align: right; padding: 12px; color: ${after.money_leaks < current.money_leaks ? '#22c55e' : '#9ca3af'};">${formatKZT(after.money_leaks)}</td>
                <td style="text-align: right; padding: 12px; color: #22c55e; font-weight: 700;">-${formatKZT(improvement.leak_reduction)}</td>
              </tr>
              <tr style="background: rgba(34,197,94,0.1); border-radius: 8px;">
                <td style="padding: 12px; font-weight: 700;">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è</td>
                <td style="text-align: right; padding: 12px;">‚Äî</td>
                <td style="text-align: right; padding: 12px; color: #22c55e; font-weight: 700;">${formatKZT(after.monthly_savings_potential)}</td>
                <td style="text-align: right; padding: 12px; color: #22c55e; font-weight: 700;">+${formatKZT(improvement.net_change)}</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
    }

    function renderActionPlan(data) {
      const plan = data.action_plan || [];
      const container = document.getElementById('action-plan');

      if (plan.length === 0) {
        container.innerHTML = '<p style="color: #9ca3af;">–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</p>';
        return;
      }

      container.innerHTML = plan.map((action, idx) => `
        <div style="background: rgba(2,6,23,0.6); border-left: 4px solid #3b82f6; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
          <div style="display: flex; gap: 16px; align-items: start;">
            <div style="background: #3b82f6; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">${idx + 1}</div>
            <div style="flex: 1;">
              <div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">${action.day}</div>
              <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #60a5fa;">${action.action}</div>
              <div style="font-size: 14px; color: #cbd5e1; line-height: 1.6;">${action.how}</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderSummary(data) {
      const totals = data.totals || {};
      const net = totals.net || 0;
      const income = totals.real_income !== undefined ? totals.real_income : totals.income || 0;
      const totalIncome = totals.income || 0;
      const spending = totals.spending || 0;
      const diffPercent = income > 0 ? ((spending / income) * 100) : 0;

      const grid = document.getElementById('summary-grid');
      const showRealIncome = totals.real_income !== undefined && totals.real_income !== totalIncome;
      grid.innerHTML = `
        <div class="summary-item">
          <div class="summary-label">${showRealIncome ? '–†–µ–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥' : '–î–æ—Ö–æ–¥—ã'}</div>
          <div class="summary-value positive">${formatKZT(income)}</div>
          ${showRealIncome ? `<div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">(–æ–±—â–∏–π: ${formatKZT(totalIncome)})</div>` : ''}
        </div>
        <div class="summary-item">
          <div class="summary-label">–†–∞—Å—Ö–æ–¥—ã</div>
          <div class="summary-value negative">${formatKZT(spending)}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">–ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
          <div class="summary-value ${net >= 0 ? 'positive' : 'negative'}">${formatKZT(net)}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">–†–∞—Å—Ö–æ–¥—ã –æ—Ç –¥–æ—Ö–æ–¥–æ–≤</div>
          <div class="summary-value ${diffPercent <= 100 ? 'positive' : 'negative'}">${formatPercent(diffPercent)}</div>
        </div>
      `;

      const insight = document.getElementById('summary-insight');
      if (net >= 0) {
        insight.className = 'insight';
        insight.textContent = `‚úÖ –í—ã –≤ –ø–ª—é—Å–µ! –ó–∞ –ø–µ—Ä–∏–æ–¥ –≤—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ –Ω–∞ ${formatKZT(net)} –±–æ–ª—å—à–µ, —á–µ–º –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏. –≠—Ç–æ —Ö–æ—Ä–æ—à–∏–π –∑–Ω–∞–∫ –¥–ª—è –≤–∞—à–µ–≥–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è.`;
      } else {
        insight.className = 'insight warning';
        insight.textContent = `‚ö†Ô∏è –í–∞—à–∏ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –¥–æ—Ö–æ–¥—ã –Ω–∞ ${formatKZT(Math.abs(net))}. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ª–∏–±–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ—Ö–æ–¥—ã, –ª–∏–±–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–æ–ª–≥–æ–≤.`;
      }
    }

    function renderIncomeExpensesChart(data) {
      const monthly = data.monthly_summary || [];
      if (monthly.length === 0) return;

      const ctx = document.getElementById('income-expenses-chart').getContext('2d');
      if (incomeExpensesChart) incomeExpensesChart.destroy();

      incomeExpensesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthly.map(m => m.month),
          datasets: [{
            label: '–î–æ—Ö–æ–¥—ã',
            data: monthly.map(m => m.income),
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.4,
            fill: true
          }, {
            label: '–†–∞—Å—Ö–æ–¥—ã',
            data: monthly.map(m => m.spending),
            borderColor: '#f97373',
            backgroundColor: 'rgba(249, 115, 115, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e5e7eb' } }
          },
          scales: {
            x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
            y: { ticks: { color: '#9ca3af', callback: (v) => formatKZT(v) }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
          }
        }
      });
    }

    function renderExpenseDonut(data) {
      const categories = (data.category_breakdown || []).filter(c => c.spending > 0);
      if (categories.length === 0) return;

      const ctx = document.getElementById('expense-donut-chart').getContext('2d');
      if (expenseDonutChart) expenseDonutChart.destroy();

      const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#6366f1', '#ef4444', '#14b8a6'];
      const total = categories.reduce((sum, c) => sum + c.spending, 0);

      expenseDonutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: categories.map(c => c.category),
          datasets: [{
            data: categories.map(c => c.spending),
            backgroundColor: colors.slice(0, categories.length),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right', labels: { color: '#e5e7eb', padding: 15 } },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const label = ctx.label || '';
                  const value = ctx.parsed || 0;
                  const percent = ((value / total) * 100).toFixed(1);
                  return `${label}: ${formatKZT(value)} (${percent}%)`;
                }
              }
            }
          }
        }
      });

      const transfers = categories.find(c => c.category === 'transfers');
      const insight = document.getElementById('expense-insight');
      if (transfers && transfers.spending > total * 0.4) {
        insight.innerHTML = `<div class="insight warning">‚ö†Ô∏è –ü–µ—Ä–µ–≤–æ–¥—ã —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç ${formatPercent((transfers.spending / total) * 100)} –≤–∞—à–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–≤–æ–¥—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã.</div>`;
      } else {
        const topCat = categories[0];
        insight.innerHTML = `<div class="insight">üí° –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤—ã —Ç—Ä–∞—Ç–∏—Ç–µ –Ω–∞ "${topCat.category}" ‚Äî ${formatPercent((topCat.spending / total) * 100)} –≤—Å–µ—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤.</div>`;
      }
    }

    function renderCreditAnalysis(data) {
      const credit = data.credit_analysis || {};
      const container = document.getElementById('credit-analysis');

      if (!credit.total_monthly || credit.total_monthly === 0) {
        container.innerHTML = '<p style="color: #9ca3af;">–ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤ –≤—ã–ø–∏—Å–∫–µ. –≠—Ç–æ —Ö–æ—Ä–æ—à–∏–π –∑–Ω–∞–∫ ‚Äî –≤—ã –Ω–µ –∑–∞–≤–∏—Å–∏—Ç–µ –æ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤.</p>';
        return;
      }

      const warningClass = credit.warning_level || 'low';
      const creditPct = credit.percentage_of_expenses || 0;
      
      let warningText, explanation, recommendation, safeThreshold;
      
      if (creditPct <= 10) {
        warningText = '–ù–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å';
        explanation = '–ö—Ä–µ–¥–∏—Ç—ã —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç –º–µ–Ω–µ–µ 10% –≤–∞—à–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —ç–∫—Å–ø–µ—Ä—Ç—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç –¥–µ—Ä–∂–∞—Ç—å –∫—Ä–µ–¥–∏—Ç–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∏–∂–µ 20% –æ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤.';
        recommendation = '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ. –ï—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –Ω–æ–≤—ã–π –∫—Ä–µ–¥–∏—Ç, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–±—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç 20%.';
        safeThreshold = '‚úÖ –ù–∏–∂–µ –Ω–æ—Ä–º—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è < 20%)';
      } else if (creditPct <= 20) {
        warningText = '–£–º–µ—Ä–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ ‚Äî –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã';
        explanation = '–ö—Ä–µ–¥–∏—Ç—ã —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç 10-20% –≤–∞—à–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤. –≠—Ç–æ –ø—Ä–∏–µ–º–ª–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å, –Ω–æ —Å—Ç–æ–∏—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Å–∏—Ç—É–∞—Ü–∏–µ–π.';
        recommendation = '–°—Ç–∞—Ä–∞–π—Ç–µ—Å—å –Ω–µ –±—Ä–∞—Ç—å –Ω–æ–≤—ã–µ –∫—Ä–µ–¥–∏—Ç—ã, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö.';
        safeThreshold = '‚ö†Ô∏è –ù–∞ –≥—Ä–∞–Ω–∏—Ü–µ –Ω–æ—Ä–º—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è < 20%)';
      } else if (creditPct <= 30) {
        warningText = '–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ ‚Äî —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è';
        explanation = '–ö—Ä–µ–¥–∏—Ç—ã —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç 20-30% –≤–∞—à–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤. –≠—Ç–æ –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å, –∫–æ—Ç–æ—Ä—ã–π –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –≤–∞—à—É —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Å–≤–æ–±–æ–¥—É. –ë–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –≤–∞—à–∏—Ö –¥–µ–Ω–µ–≥ —É—Ö–æ–¥–∏—Ç –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –¥–æ–ª–≥–æ–≤.';
        recommendation = '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –∫—Ä–µ–¥–∏—Ç–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ, –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—é –¥–æ–ª–≥–æ–≤ –∏–ª–∏ –¥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ. –ù–µ –±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–µ –∫—Ä–µ–¥–∏—Ç—ã.';
        safeThreshold = '‚ö†Ô∏è –í—ã—à–µ –Ω–æ—Ä–º—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è < 20%)';
      } else {
        warningText = '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ ‚Äî —Å—Ä–æ—á–Ω—ã–µ –º–µ—Ä—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã';
        explanation = '–ö—Ä–µ–¥–∏—Ç—ã —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç –±–æ–ª–µ–µ 30% –≤–∞—à–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –æ–ø–∞—Å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å. –í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –ª–æ–≤—É—à–∫–µ, –≥–¥–µ –±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –¥–æ—Ö–æ–¥–∞ —É—Ö–æ–¥–∏—Ç –Ω–∞ –ø—Ä–æ—Ü–µ–Ω—Ç—ã. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–∫—Ä—ã–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—é –Ω–æ–≤—ã—Ö –¥–æ–ª–≥–æ–≤.';
        recommendation = '–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–º—É –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É –∏–ª–∏ –≤ –±–∞–Ω–∫ –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏–∏ –¥–æ–ª–≥–æ–≤. –ù–µ –±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–µ –∫—Ä–µ–¥–∏—Ç—ã –Ω–∏ –ø—Ä–∏ –∫–∞–∫–∏—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è, –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è.';
        safeThreshold = '‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤—ã—à–µ –Ω–æ—Ä–º—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è < 20%)';
      }

      container.innerHTML = `
        <div class="credit-warning ${warningClass}">
          <h3 style="margin-bottom: 12px;">${warningText}</h3>
          <div style="margin-bottom: 16px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
            <div style="font-size: 14px; color: #cbd5e1; line-height: 1.6; margin-bottom: 12px;">${explanation}</div>
            <div style="font-size: 13px; font-weight: 600; color: ${warningClass === 'high' ? '#f97373' : warningClass === 'medium' ? '#fbbf24' : '#22c55e'};">${safeThreshold}</div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
            <div>
              <div style="font-size: 13px; color: #9ca3af; margin-bottom: 4px;">–°—Ä–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂ –≤ –º–µ—Å—è—Ü</div>
              <div style="font-size: 24px; font-weight: 700; color: ${warningClass === 'high' ? '#f97373' : '#fbbf24'}">${formatKZT(credit.total_monthly)}</div>
            </div>
            <div>
              <div style="font-size: 13px; color: #9ca3af; margin-bottom: 4px;">% –æ—Ç –≤—Å–µ—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
              <div style="font-size: 24px; font-weight: 700; color: ${warningClass === 'high' ? '#f97373' : '#fbbf24'}">${formatPercent(credit.percentage_of_expenses)}</div>
            </div>
          </div>
          <div style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; border-radius: 8px;">
            <div style="font-size: 13px; font-weight: 600; color: #60a5fa; margin-bottom: 4px;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</div>
            <div style="font-size: 14px; color: #cbd5e1; line-height: 1.6;">${recommendation}</div>
          </div>
        </div>
      `;

      if (credit.recurring_payments && credit.recurring_payments.length > 0) {
        container.innerHTML += '<h3 style="margin-top: 24px;">–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:</h3>';
        credit.recurring_payments.forEach(p => {
          container.innerHTML += `
            <div class="leak-item">
              <div>
                <div style="font-weight: 600;">${p.merchant}</div>
                <div style="font-size: 12px; color: #9ca3af;">${p.frequency} –ø–ª–∞—Ç–µ–∂(–µ–π)</div>
              </div>
              <div style="font-weight: 700; color: #f97373;">${formatKZT(p.monthly_amount)}</div>
            </div>
          `;
        });
      }
    }

    function renderLeakAnalysis(data) {
      const leaks = data.money_leaks || {};
      const container = document.getElementById('leak-analysis');

      if (!leaks.leak_sources || leaks.leak_sources.length === 0) {
        container.innerHTML = '<p style="color: #9ca3af;">–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–µ–∑–∞–º–µ—Ç–Ω—ã—Ö —Ç—Ä–∞—Ç –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.</p>';
        return;
      }

      container.innerHTML = `
        <div class="insight warning">
          üí∏ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${leaks.leak_sources.length} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –Ω–µ–∑–∞–º–µ—Ç–Ω—ã—Ö —Ç—Ä–∞—Ç, –∫–æ—Ç–æ—Ä—ã–µ –≤ —Å—É–º–º–µ —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç ${formatKZT(leaks.total_monthly)} –≤ –º–µ—Å—è—Ü.
        </div>
        <div style="margin-top: 16px;">
          ${leaks.leak_sources.map(leak => `
            <div class="leak-item">
              <div>
                <div style="font-weight: 600;">${leak.merchant}</div>
                <div style="font-size: 12px; color: #9ca3af;">${leak.count} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, —Å—Ä–µ–¥–Ω—è—è: ${formatKZT(leak.avg)}</div>
              </div>
              <div style="font-weight: 700; color: #f97373;">${formatKZT(leak.total)}</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderRecommendations(data) {
      const recs = data.recommendations || [];
      const container = document.getElementById('recommendations');

      if (recs.length === 0) {
        container.innerHTML = '<p style="color: #9ca3af;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</p>';
        return;
      }

      container.innerHTML = recs.map(rec => `
        <div class="recommendation">
          <div class="recommendation-title">${rec.title}</div>
          <div class="recommendation-desc">${rec.description}</div>
          <div class="recommendation-savings">
            <span>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è:</span>
            <strong>${formatKZT(rec.monthly_savings)}/–º–µ—Å—è—Ü</strong>
            <span class="impact-badge impact-${rec.impact === '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π' || rec.impact === '–í—ã—Å–æ–∫–∏–π' ? 'high' : rec.impact === '–°—Ä–µ–¥–Ω–∏–π' ? 'medium' : 'low'}">${rec.impact}</span>
          </div>
        </div>
      `).join('');
    }
  </script>
</body>
</html>
